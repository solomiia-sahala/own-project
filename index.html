<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather&display=swap" rel="stylesheet">
    <script src="https://kit.fontawesome.com/554bbb5ec0.js" crossorigin="anonymous"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.3/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.14.2/firebase-auth.js"></script>
    <script src="/static/js/firebaseConfig.js"></script>
    <title>Share Travel Way</title>
</head>

<body>
    <div id="box">
        <div id="box-inner"></div>

        <form>
            <h4>Please, sing in!</h4>
            <table>
                <tr>
                    <td>Email:</td>
                    <td>
                        <input type="email" id="email">
                    </td>
                </tr>
                <tr>
                    <td>Password:</td>
                    <td>
                        <input type="password" id="password">
                    </td>
                </tr>
                <tr>
                    <td><button id="sing-in" class="btn">Sing in</button></td>
                </tr>
            </table>
            <h4>No account yet? Click to <a href="sing_up">create</a>.</h4>
        </form>
    </div>

    <header>
        <div id="header-container">

            <video autoplay muted loop id="myVideo">
                <source src="/static/video/video2.mp4" type="video/mp4">
                Your browser does not support HTML5 video.
            </video>

            <!-- <img src="http://localhost:3000/static/img/action-blur-car-child-386009.jpg" alt="car"> -->
            <div id="user">
                <img id="logo" src="/static/img/iconfinder_aeaaqas_3305206.png" alt="">
                <div class="topnav dropdown" id="myTopnav">
                    <button id="name" class="dropbtn">
                    </button>
                    <div class="dropdown-content">
                        <!-- <a href="my_profile">My profile</a> -->
                        <a onclick="userProfile();">My profile</a>
                        <a onclick="userArticles();">Articles</a>
                        <a href="help">Help</a>
                        <button id="logOut" class="btn">Log out!</button>
                    </div>
                </div>
                <!-- <span id="name">Hello</span> -->

            </div>
            <div class="prime-info">
                <h1>Share <span class="colored-word">your way</span> to know more about secret places!</h1>
                <p>Lorem ipsum dolor sit amet consectetur, adipisicing elit. Vitae rem magni fugiat quis, totam odio
                    veniam perferendis earum voluptates. Labore! Vitae rem magni fugiat quis, totam odio
                    veniam perferendis earum voluptates.</p>

            </div>
        </div>
    </header>
    <br>

    <hr class="style-seven">



    <section class="container">
        <h2>Find more info with our <span class="colored-word">articles!</span></h2>
        <div class="add-article">
            <h3><i class="fas fa-pencil-alt"></i> Or share your story with us</h3>
            <a href="create_article"><span>Create article</span></a>
        </div>
    </section>
    <section id="blog">
        <div class="articles-container" id="grid_container">
            <!-- <article class="post">
                <img src="http://localhost:3000/static/img/man-wearing-red-dress-shirt-beside-water-buffalo-752398.jpg" alt="article-1">
                <div>
                    <h3>The least-visited countries in Europe</h3>
                    <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Ad laudantium quisquam corrupti
                        repellendus praesentium perspiciatis quam asperiores! Unde iste earum sapiente possimus iusto.
                        Magni, ipsam dolor! Ipsum atque aperiam corrupti?</p>
                    <button class="btn">Read More...</button>
                </div>

            </article> -->

        </div>
        <div class="pagination">
            <!-- <button id="lessButton" onclick="showLess()"><i class="fas fa-caret-square-up"></i></button> -->
            <button id="moreButton" onclick="showMore()"><i class="fas fa-caret-square-down"></i></button>
        </div>

    </section>

    <hr class="style-seven">

    <footer>
        <section class="footer-info">
            <div class="number">

                <h4><i class="fas fa-phone fa-1x"></i> Call:</h4>
                <p>456-23-568</p>
                <p>125-33-223</p>
            </div>

            <div class="email">
                <h4><i class="fas fa-envelope-open-text fa-1x"></i> Contact</h4>
                <p>myourway@link.com</p>
            </div>

            <div class="social">
                <h4>Follow us</h4>
                <i class="fab fa-twitter fa-2x"></i>
                <i class="fab fa-facebook fa-2x"></i>
                <i class="fab fa-instagram fa-2x"></i>
            </div>

            <div class="copy-right">
                <p>&copy; 2020 by SS and Wkyn</p>
                <p>Created by practice lessons</p>
            </div>

        </section>

    </footer>

    <script>
        // store all data in LocalStorage

        // localStorage.setItem('article_1', JSON.stringify({
        //     'header': 'The least-visited countries in Europe',
        //     'description' : 'Lorem ipsum dolor sit amet consectetur adipisicing elit. Ad laudantium quisquam corrupti repellendus praesentium perspiciatis quam asperiores! Unde iste earum sapiente possimus iusto.Magni, ipsam dolor! Ipsum atque aperiam corrupti?',
        //     'image' : './img/house-on-green-landscape-against-sky-314937.jpg',
        // }));

        // localStorage.setItem('article_2', JSON.stringify({
        //     'header': 'Walk hard, play hard',
        //     'description' : 'Lorem ipsum dolor sit amet consectetur adipisicing elit. Ad laudantium quisquam corrupti repellendus praesentium perspiciatis quam asperiores! Unde iste earum sapiente possimus iusto.Magni, ipsam dolor! Ipsum atque aperiam corrupti?',
        //     'image' : './img/man-standing-on-green-grass-field-under-white-sky-1660898.jpg',
        // }));

        // localStorage.setItem('article_3', JSON.stringify({
        //     'header': 'The year to plan a trip with friends',
        //     'description' : 'Lorem ipsum dolor sit amet consectetur adipisicing elit. Ad laudantium quisquam corrupti repellendus praesentium perspiciatis quam asperiores! Unde iste earum sapiente possimus iusto.Magni, ipsam dolor! Ipsum atque aperiam corrupti?',
        //     'image' : './img/road-nature-trees-branches-38537.jpg',
        // }));


        // get all keys with data


        const url = 'https://myourway.firebaseio.com/trip-articles.json';

        async function getData(url) {
            let response = await fetch(url);
            if (response.ok) {
                let json = await response.json();
                if (!json) {
                    return;
                }
                let keys = Object.keys(json);
                for (let key of keys) {
                    createElem(json[key], key);
                }
                showMore();
            } else {
                alert(`Error: ${response.status}`);
            }

        }


        // generate new article in grid_container
        function createElem(article, key) {
            grid_container.insertAdjacentHTML('beforeend', '<article class="post hidden">'
                + `<div id="article-header"><div id="location"><i class="fas fa-map-pin"></i> Location</div><div>@<a href="user_articles/${article.author.id}">${article.author.nickname}</a></div></div>`
                + `<img src="${article.image}" alt="article-2">`
                + `<div><h3>${article.header}</h3>`
                + `<p>${article.description}</p>`
                + `<button id="${key}" class="btn readMe_button">Read More...</button></div></article>`);

            document.getElementById(key).onclick = function () {
                window.location.pathname = `read_me/${key}`;
            }
        }

        // let url = new URL(window.location.href);
        // let header = url.searchParams.get('header');
        // let description = url.searchParams.get('description');
        // let image = url.searchParams.get('myFile');

        // if (header && description && image) {
        //     createElem(header, description, image);
        // } 

        getData(url);

        firebase.auth().onAuthStateChanged(user => {
            //TODO make more meaningful)
            console.log('state: ' + (user != null ? 'logged in' : 'logged out'));
            updateSingInView();
        });

        function updateSingInView() {
            if (firebase.auth().currentUser != null) {
                document.getElementById('box').style.setProperty('display', 'none');
                document.body.style.overflow = 'auto'
                getUserName(firebase.auth().currentUser.uid);
                document.getElementById('user').style.setProperty('display', 'block');
            } else {
                document.getElementById('box').style.setProperty('display', 'block');
                document.body.style.overflow = 'hidden';
                document.getElementById('user').style.setProperty('display', 'none');
            }
        }

        document.getElementById('sing-in').onclick = async function (e) {
            e.preventDefault();
            let email = document.getElementById('email').value;
            let password = document.getElementById('password').value;

            try {
                await firebase.auth().signInWithEmailAndPassword(email, password);
            } catch (err) {
                alert(err.message);
                return;
            }
        }

        document.getElementById('logOut').onclick = async function () {
            try {
                await firebase.auth().signOut();
            }
            catch (error) {
                alert(error.message);
            }
        }

        // display user name in header

        async function getUserName(id) {
            let response = await fetch(`https://myourway.firebaseio.com/users/${id}/name.json`);
            if (response.ok) {
                let name = await response.json();
                document.getElementById('name').innerHTML = `Hello, ${name}`;
            } else {
                alert(`Error: ${response.status}`);
            }
        }


        //go to user profile

        function userProfile() {
            let user = firebase.auth().currentUser.uid;
            window.location.pathname = `/user_profile/${user}`;
        }
        function userArticles() {
            let user = firebase.auth().currentUser.uid;
            window.location.pathname = `/user_articles/${user}`;
        }


        // pagination ream more and less buttons

        function showMore() {
            let listData = Array.prototype.slice.call(document.querySelectorAll('#grid_container article:not(.shown)')).slice(0, 3);
            // let listData = grid_container.querySelectorAll('article');
            for (let i = 0; i < listData.length; i++) {
                listData[i].className = 'post shown';
            }
            switchButtons();
        }

        // function showLess() {
        //     let listData = Array.prototype.slice.call(document.querySelectorAll('#grid_container article:not(.hidden)')).slice(-3);
        //     for (let i = 0; i < listData.length; i++) {
        //         listData[i].className = 'post hidden';
        //     }
        //     switchButtons();
        // }

        function switchButtons() {
            let hiddenElements = Array.prototype.slice.call(document.querySelectorAll('#grid_container article:not(.shown)'));
            if (hiddenElements.length == 0) {
                document.getElementById('moreButton').style.display = 'none';
            }
            else {
                document.getElementById('moreButton').style.display = 'block';
            }

            // let shownElements = Array.prototype.slice.call(document.querySelectorAll('#grid_container article:not(.hidden)'))
            // if (shownElements.length == 0) {
            //     document.getElementById('lessButton').style.display = 'none';
            // }
            // else {
            //     document.getElementById('lessButton').style.display = 'block';
            // }
        }

    </script>

</body>

</html>